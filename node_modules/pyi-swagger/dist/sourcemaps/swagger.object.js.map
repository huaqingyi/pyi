{"version":3,"sources":["swagger.object.ts"],"names":[],"mappings":"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","file":"../swagger.object.js","sourcesContent":["/**\n * used for building swagger docs object\n */\nimport is from 'is-type-of';\nimport _ from 'ramda';\nimport { reservedMethodNames } from 'koa-swagger-decorator/dist/utils';\nimport { Data } from 'koa-swagger-decorator/dist/types';\nimport init from 'koa-swagger-decorator/dist/swaggerTemplate';\nimport { getPath } from 'koa-swagger-decorator/dist/utils';\n\nexport class SwaggerInjectService {\n    private static _this: SwaggerInjectService;\n\n    public static register() {\n        if (!SwaggerInjectService._this) {\n            SwaggerInjectService._this = new SwaggerInjectService();\n        }\n        return SwaggerInjectService.runtime();\n    }\n\n    public static runtime() {\n        if (!SwaggerInjectService._this) throw 'not register SwaggerInjectService service ...';\n        return SwaggerInjectService._this;\n    }\n\n    public data: Data;\n\n    constructor() {\n        this.data = {};\n    }\n\n    public add(target: any, name: string, content: any) {\n        if (!is.object(content)) {\n            throw new Error('illegal params [content] for SwaggerInjectService.add');\n        }\n\n        // when using non-static method decorators\n        // target will be class.prototype rather than class\n        // hack and make target always be class itself\n        if (!target.prototype && target.constructor) {\n            target = target.constructor;\n        }\n\n        const key = `${target.name}-${name}`;\n        if (!this.data[key]) this.data[key] = {};\n\n        // merge class decorator and method decorator if it is an array\n        // eg. query parameters, tag paramemters\n        Object.keys(content).forEach((k) => {\n            if (is.array(this.data[key][k])) {\n                this.data[key][k] = [...this.data[key][k], ...content[k]];\n                if (this.data[key][k].length === 0) return;\n                this.data[key][k] = is.object(this.data[key][k][0]) ?\n                    _.uniqBy((o: { name: string }) => o.name, this.data[key][k])\n                    : _.uniq(this.data[key][k]);\n            } else {\n                Object.assign(this.data[key], { [k]: content[k] });\n            }\n        });\n    }\n\n    // only add to methods with a @request decorator\n    public addMulti(target: any, content: any, filters = ['ALL']) {\n        const staticMethods = Object.getOwnPropertyNames(target)\n            .filter(method => !reservedMethodNames.includes(method));\n        const methods = Object.getOwnPropertyNames(target.prototype)\n            .filter(method => !reservedMethodNames.includes(method));\n\n        [...staticMethods, ...methods].forEach((name) => {\n            const key = `${target.name}-${name}`;\n            if (!this.data[key] || !this.data[key].request) return;\n            filters = filters.map(i => i.toLowerCase());\n            if (\n                filters.includes('all') ||\n                filters.includes(this.data[key].request.method)\n            ) {\n                this.add(target, name, content);\n            }\n        });\n    }\n\n    public toJSON(options?: {\n        title?: string,\n        description?: string,\n        version?: string,\n        swaggerOptions?: object\n    }) {\n        if (!options) options = {};\n        const {\n            title,\n            description,\n            version,\n            prefix = '',\n            swaggerOptions = {}\n        } = options as any;\n        const swaggerJSON: any = init(title, description, version, swaggerOptions);\n        Object.keys(this.data).forEach((key) => {\n            const value = this.data[key];\n            if (!Object.keys(value).includes('request')) {\n                return;\n            }\n\n            const { method } = value.request;\n            let { path } = value.request;\n            path = getPath(prefix, value.prefix ? `${value.prefix}${path}` : path); // 根据前缀补全path\n            const summary = value.summary || '';\n            const description = value.description || summary;\n            const responses = value.responses || {\n                200: { description: 'success' }\n            };\n            const {\n                query = [],\n                path: pathParams = [],\n                body = [],\n                tags,\n                formData = [],\n                security,\n                deprecated\n            } = value;\n\n            const parameters = [...pathParams, ...query, ...formData, ...body];\n\n            // init path object first\n            if (!swaggerJSON.paths[path]) {\n                swaggerJSON.paths[path] = {};\n            }\n\n            // add content type [multipart/form-data] to support file upload\n            const consumes = formData.length > 0 ? ['multipart/form-data'] : undefined;\n\n            swaggerJSON.paths[path][method] = {\n                consumes,\n                summary,\n                description,\n                parameters,\n                responses,\n                tags,\n                security,\n                deprecated\n            };\n        });\n        return swaggerJSON;\n    };\n}\n"]}