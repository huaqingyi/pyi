{"version":3,"sources":["lib/chokidar.ts"],"names":[],"mappings":"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","file":"../../lib/chokidar.js","sourcesContent":["import chokidar, { FSWatcher } from 'chokidar';\nimport { blue, magenta, green } from 'colors';\nimport { map, extend } from 'lodash';\nimport { AppConfigOption, PYIAutoAppConfiguration } from '../core';\nimport { createKoaServer, PYIController, PYIMiddleware, PYIInterceptor } from '../decorators';\nimport { Server, createServer } from 'http';\nimport bodyParser from 'koa-bodyparser';\nimport { join } from 'path';\nimport { PYIArgs } from './pyi.args';\n\nexport class PYIChokidar {\n    public static runtime(dirname: string, application: any) {\n        return new PYIChokidar(dirname, application, PYIArgs.reflact().config);\n    }\n\n    private dirname: string;\n    private config: AppConfigOption;\n    private watcher: FSWatcher;\n    private files: { [x: string]: any };\n    private app!: Server;\n    private port: number;\n    private application: any;\n\n    constructor(dirname: string, application: any, config: AppConfigOption) {\n        this.dirname = dirname;\n        this.config = config;\n        this.port = config.server.port || 4003;\n        this.config.entry = dirname;\n        this.config.output = join(dirname, 'runtime');\n        this.files = {};\n        this.watcher = chokidar.watch(this.dirname);\n        this.application = application;\n\n        this.watcher.on('add', this.addFile.bind(this));\n        this.watcher.on('ready', this.ready.bind(this));\n    }\n\n    public async authFileExt(path: string) {\n        if (this.config.resolve && this.config.resolve.extensions) {\n            const exts = this.config.resolve.extensions.join('|').split('.').join('');\n            return await new RegExp(`.(${exts})$`, 'gi').test(path);\n        }\n        return false;\n    }\n\n    public async addFile(path: string) {\n        if (!await this.authFileExt(path)) { return false; }\n        const comp = await import(path);\n        if (!comp) { return false; }\n        map(comp, (o, i) => {\n            if (!comp[i]) { return o; }\n            if (comp[i]._pyi) {\n                const _pyi = comp[i]._pyi();\n                comp[i]._pyi = () => ({\n                    ..._pyi, path,\n                    mode: this.config.mode,\n                    watch: this.config.watch\n                });\n            }\n            if (!comp[i]._extends) { return comp[i]; }\n            if (comp[i]._extends() === PYIAutoAppConfiguration) {\n                const Setting = comp[i];\n                const { props } = comp[i].prototype;\n                const config = (new Setting(this.config, props))._runtime(this.config);\n                if (!config.entry) { delete config.entry; }\n                if (!config.output) { delete config.output; }\n                if (\n                    process.argv.indexOf('-p') !== -1 ||\n                    process.argv.indexOf('--port') !== -1 ||\n                    process.argv.indexOf('--p') !== -1\n                ) {\n                    console.log(green(`listen use command port: ${this.config.server.port}`));\n                    delete config.port;\n                }\n                this.config = extend(this.config, config);\n                this.port = this.config.server.port || 4003;\n                PYIArgs.reset(this.config);\n            }\n        });\n        this.files[path] = comp;\n        console.log(blue(`File ${path} has been added ...`));\n    }\n\n    public async loadApplication() {\n        await this.watcher.close();\n\n        const controllers: Function[] = [];\n        const middlewares: Function[] = [];\n        const interceptors: Function[] = [];\n        map(this.files, (comp) => {\n            if (!comp._extends) { return comp; }\n            if (comp._extends() === PYIController) { controllers.push(comp); }\n            if (comp._extends() === PYIMiddleware) { middlewares.push(comp); }\n            if (comp._extends() === PYIInterceptor) { interceptors.push(comp); }\n        });\n\n        const app = createKoaServer({\n            ...this.config.pyi,\n            controllers,\n            middlewares,\n            interceptors\n        });\n\n        app.use(bodyParser());\n\n        let host = 'localhost';\n\n        if (this.config.server) {\n            host = this.config.server.host || 'localhost';\n        }\n\n        try {\n            this.app = await createServer(app.callback()).listen(this.port);\n        } catch (err) {\n            ++this.port;\n            await this.loadApplication();\n        }\n        console.log(magenta(`Hello Starter PYI Server: Listen on http://${host}:${this.port}`));\n        return await this.app;\n    }\n\n    public async ready() {\n        await this.application.complete.next({\n            starter: this.loadApplication.bind(this),\n            config: this.config,\n            watcher: this.watcher\n        });\n    }\n}\n"]}