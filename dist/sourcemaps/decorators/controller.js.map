{"version":3,"sources":["decorators/controller.ts"],"names":[],"mappings":"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","file":"../../decorators/controller.js","sourcesContent":["import { PYICore, PYIApp, PYICoreClass } from '../core';\n\nimport {\n    Middleware as RMiddleware,\n    Interceptor as RInterceptor,\n    getMetadataArgsStorage,\n    ActionMetadata,\n} from '../extends';\nimport { map } from 'lodash';\nimport { ActionType } from 'routing-controllers/metadata/types/ActionType';\nimport { Context } from 'koa';\n// tslint:disable-next-line:no-var-requires\nconst pathToRegExp = require('path-to-regexp');\nimport jwt from 'jsonwebtoken';\nimport { ResponseDto } from './dto';\n\nexport * from '../extends';\n\n/**\n * Controller ================================\n */\nexport enum RequestMappingMethod {\n    GET = 'GET',\n    POST = 'POST',\n    DELETE = 'DELETE',\n    PUT = 'PUT',\n    PATCH = 'PATCH',\n    CONNECT = 'CONNECT',\n    CHECKOUT = 'CHECKOUT',\n    COPY = 'COPY',\n    HEAD = 'HEAD',\n    LOCK = 'LOCK',\n    MERGE = 'MERGE',\n    MKACTIVITY = 'MKACTIVITY',\n    MKCOL = 'MKCOL',\n    MOVE = 'MOVE',\n    M_SEARCH = 'm-search',\n    NOTIFY = 'NOTIFY',\n    OPTIONS = 'OPTIONS',\n    PROPFIND = 'PROPFIND',\n    PROPPATCH = 'PROPPATCH',\n    PURGE = 'PURGE',\n    REPORT = 'REPORT',\n    SEARCH = 'SEARCH',\n    SUBSCRIBE = 'SUBSCRIBE',\n    TRACE = 'TRACE',\n    UNLOCK = 'UNLOCK',\n    UNSUBSCRIBE = 'UNSUBSCRIBE'\n}\n\nexport interface ControllerConfiguration {\n    prefix?: string;\n}\n\nexport interface ControllerRequestConfiguration extends ControllerConfiguration {\n    prefix?: string;\n    methods?: string[] | RequestMappingMethod[];\n    description?: string;\n    summary?: string;\n    swaggerDocument?: any;\n    security?: any[];\n}\n\nexport function JsonController(baseRoute?: string) {\n    return <VC extends PYICoreClass<PYIController>>(control: VC): VC => {\n        (getMetadataArgsStorage().actions as any) = map(getMetadataArgsStorage().actions, (action) => {\n            const { target, route } = action;\n            if (target === control) {\n                const path = pathToRegExp(ActionMetadata.appendBaseRoute(baseRoute || '', route));\n                return { ...action, path };\n            }\n            return action;\n        });\n        getMetadataArgsStorage().controllers.push({\n            type: 'json', target: control, route: baseRoute || ''\n        });\n        return control;\n    };\n}\n\nexport function Controller<VC extends PYICoreClass<PYIController>>(tprops: VC): VC;\nexport function Controller<Props = any>(\n    props: Props & any\n): <VC extends PYICoreClass<PYIController>>(target: VC) => VC;\nexport function Controller<Props extends any>(props: Props) {\n    if (props._base && props._base() === PYIController) {\n        JsonController(undefined)(props as any);\n        return props;\n    } else {\n        return (target: PYIApp) => {\n            target.prototype.props = props;\n            const { prefix } = props;\n            JsonController(prefix ? prefix : undefined)(target as any);\n            return target;\n        };\n    }\n}\n\ntype NewType = Promise<Function[]> | Function[];\n\nexport interface PYIServletController {\n    excludeJWT?: () => NewType;\n    servlet?: (\n        action: Function,\n        secretKey: string,\n        context: any,\n        next: (err?: any) => Promise<any>\n    ) => any;\n}\n\nexport class PYIController<Props = any> extends PYICore implements PYIServletController {\n    public static _base(): PYIApp {\n        return PYIController;\n    }\n\n    public props!: Props;\n\n    // public excludeJWT() {\n    //     return [];\n    // }\n\n    public async servlet(action: Function, secretKey: string, context: any, next: (err?: any) => Promise<any>) {\n        jwt.verify(context.header.authorization, secretKey, async (err: any, decode: any) => {\n            if (err) {\n                const dto = new ResponseDto({});\n                dto.errcode = 1000;\n                context.body = await dto.throws(err);\n                await next(context);\n            } else {\n                context.state.token = decode;\n                await next();\n            }\n        });\n    }\n}\n\nexport function Method(method, route, docs?: any) {\n    return (object, methodName) => {\n        getMetadataArgsStorage().actions.push({\n            type: method,\n            target: object.constructor,\n            method: methodName,\n            route, docs,\n        } as any);\n    };\n}\n\nexport function RequestMapping(config: ControllerRequestConfiguration | PYIController, key?: string): any {\n    if (key) {\n        map(RequestMappingMethod, (m) => {\n            Method(m as any, undefined)(config, key);\n        });\n    } else {\n        // tslint:disable-next-line:no-shadowed-variable\n        return (target: any, key: string) => {\n            const { prefix, methods } = config as ControllerRequestConfiguration;\n            map(methods && methods.length > 0 ? methods : RequestMappingMethod, (m) => {\n                Method(m as ActionType, prefix, config)(target, key);\n            });\n        };\n    }\n}\n\nexport interface PYIMiddlewareProps {\n    type: 'after' | 'before';\n    priority?: number;\n}\n\nexport function Middleware<VC extends PYICoreClass<PYIMiddleware>>(tprops: VC): VC;\nexport function Middleware<Props = PYIMiddlewareProps>(\n    props: Props & PYIMiddlewareProps\n): <VC extends PYICoreClass<PYIMiddleware>>(target: VC) => VC;\nexport function Middleware<Props extends any>(props: Props) {\n    if (props._base && props._base() === PYIMiddleware) {\n        props.prototype.props = { type: 'before' };\n        RMiddleware({ type: 'before' })(props);\n        return props;\n    } else {\n        return (target: PYIApp) => {\n            target.prototype.props = props;\n            RMiddleware(props as any)(target);\n            return target;\n        };\n    }\n}\n\nexport class PYIMiddleware<Props = any> extends PYICore {\n    public static _base(): PYIApp {\n        return PYIMiddleware;\n    }\n\n    public props!: Props;\n}\n\nexport interface PYIInterceptorProps {\n    priority?: number;\n}\n\nexport function Interceptor<VC extends PYICoreClass<PYIInterceptor>>(tprops: VC): VC;\nexport function Interceptor<Props = PYIInterceptorProps>(\n    props: Props & PYIInterceptorProps\n): <VC extends PYICoreClass<PYIInterceptor>>(target: VC) => VC;\nexport function Interceptor<Props extends any>(props: Props) {\n    if (props._base && props._base() === PYIInterceptor) {\n        props.prototype.props = {};\n        RInterceptor()(props);\n        return props;\n    } else {\n        return (target: PYIApp) => {\n            target.prototype.props = props;\n            RInterceptor(props)(target);\n            return target;\n        };\n    }\n}\n\nexport class PYIInterceptor<Props = any> extends PYICore {\n    public static _base(): PYIApp {\n        return PYIInterceptor;\n    }\n\n    public props!: Props;\n}\n"]}